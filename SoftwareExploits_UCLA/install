#!/bin/bash

# now Debian-only -- 8/22/12 -- pahp


DEBUG=0 # set to 1 to DISABLE lockout and share-unmounting for testing
KEEPLOG=0 # keep or delete install log

ILOG="/var/log/labinstall.log"
touch $ILOG
chmod 666 $ILOG

echo "Starting 'install'" > $ILOG

# installer for exploits lab
export LAB="SoftwareExploits_UCLA"
export BASE="/share/education"
export SOURCE="ExerciseCommon_UCLA"

export THISLAB="$BASE/$LAB" # lab directory
export DOWNLOADS="$BASE/$SOURCE" # repos

# support software
export INSTALL="$DOWNLOADS/scripts" 

# cd into the lab directory
pushd $THISLAB

# load the helper functions
export FUNCTIONS="$INSTALL/functions"
source $FUNCTIONS


echo ">>> Beginning additional configuration of node for '$LAB' lab." >> $ILOG

echo "installing software"

#echo "Installing new /etc/sudoers file..."
#cp -f $THISLAB/confs/sudoers /etc/sudoers
#chmod 440 /etc/sudoers
#chmod 755 /root

YesLogin

####################################
# install the relevant debian packages
####################################

apt-get update
apt-get install elinks links wget curl tcpdump -y

DF_TMP=$DEBIAN_FRONTEND # save this var
export DEBIAN_FRONTEND=noninteractive # allow install without password

# set password for mysql
debconf-set-selections <<< 'mysql-server-5.1 mysql-server/root_password password zubaz99'
debconf-set-selections <<< 'mysql-server-5.1 mysql-server/root_password_again password zubaz99'

# install apache, php, mysql, and perl
#apt-get install perl-suid -y &>> $ILOG
tasksel install lamp-server &>> $ILOG

# PHP5 is automatically installed and configured.

export DEBIAN_FRONTEND=$DF_TMP # restore default

####################################
# memo.cgi installation
####################################
# Set up user accounts for Memo

echo "Setting up user accounts..."
rm -rf /home/* &>> $ILOG

# setting real passwords (see DevNotes)
useradd wilbar -p '$1$fRqkTieO$w25jISnCEBihVb/s.c.lX0' &>> $ILOG
useradd megaboz -p '$1$9hfkqg8Y$9ISt4JPDqQq.Ik6..rZXo1'
useradd barbazzo -p '$1$UKoOQUPw$vtrmLJpKLSKoV6LTlbJBD1'
useradd gustar -p '$1$YSSC3aFg$l6bRcjnZmmRAQV30Sxe.R/'

cp -r $THISLAB/memo/setup/home/* /home/ &>> $ILOG
cp -r $THISLAB/memo/setup/root/* /root/

pushd /home/
for i in *
do
	  chown $i:$i -R /home/$i
done
popd

echo "Installing memo.cgi" >> $ILOG

cp $THISLAB/memo/memo.cgi /usr/lib/cgi-bin/
chown root:root /usr/lib/cgi-bin/memo.cgi
chmod u+s /usr/lib/cgi-bin/memo.cgi
chmod go+rx /usr/lib/cgi-bin/memo.cgi

####################################
# fhttpd installation
####################################
echo "Installing fhttpd" >> $ILOG

FHTTPD="/usr/local/fhttpd"
mkdir -p $FHTTPD

echo "Copying files..." &>> $ILOG
# note that ASLR is disabled in fhttpd.init
cp $THISLAB/confs/fhttpd.init /etc/init.d/ &>> $ILOG
/usr/sbin/update-rc.d fhttpd.init defaults

cp $THISLAB/fhttpd/server/index.html $FHTTPD/ &>> $ILOG
cp $THISLAB/fhttpd/server/frobnick/*.frob $FHTTPD/ &>> $ILOG
cp -r $THISLAB/fhttpd/* $FHTTPD/ &>> $ILOG

pushd $FHTTPD
make &>> $ILOG
make install &>> $ILOG
popd

ln -sf /usr/local/fhttpd/fhttpd /usr/sbin &>> $ILOG

echo "Copying source to /usr/src..." &>> $ILOG
cp -ar $THISLAB/fhttpd /usr/src/ &>> $ILOG


####################################
# fccu php script installation
####################################
DoOrDie $INSTALL/fccu "fccu.debian"
mkdir -p /var/www/fccu
cp $THISLAB/htdocs/index.html /var/www/
cp -ar $THISLAB/fccu/html/* /var/www/fccu/
cp -ar $THISLAB/fccu/cgi/* /usr/lib/cgi-bin/
mysql -uroot -pzubaz99 < $THISLAB/fccu/fccu.sql
/etc/init.d/mysql restart
/etc/init.d/apache2 restart


####################################
# root level web docs
####################################
if ! cp -ar $THISLAB/htdocs/* /var/www/
then
	echo "Couldn't install root level docs." >> $ILOG
fi

####################################
# sundry scripts available in /root
####################################
echo "Installing submission materials..."
if ! cp -ar $THISLAB/root /
then
	echo "Couldn't install scripts in /root" >> $ILOG
else
	chmod 755 /root/*.sh
fi


echo "Success! Creating success stamp."
CreateStamp




# unmount source files
if [ $DEBUG -eq 0 ] # do this only if "for reals"
then
	$INSTALL/umountshare &
	$INSTALL/umountproj &
fi

if [ $KEEPLOG -eq 0 ]
then
	rm $ILOG
	rm /tmp/labinstall.log
fi
